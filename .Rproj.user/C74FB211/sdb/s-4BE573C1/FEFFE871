{
    "contents" : "\nrequire(fOptions)\nrequire(xts)\nrequire(dplyr)\nrequire(ggplot2)\nrequire(scales)\nrequire(grid)\nrequire(gridExtra)\n\n# Final data preparations\nload('rubswap.RData')\nrub3m = rubmrtk[, c('USD.RUB', 'swap3m_perc', 'iv3m')]\nnames(rub3m) = c('rub', 'swap', 'iv')\nrub3m$iv = rub3m$iv/100\n\n#\n# 3m options prices every day\n# \nrub3m$call = (as.data.frame(rub3m) %>% mutate(call = GBSOption('c', rub, rub, 90/365, swap, 0, iv)@price))[, c('call')]\nrub3m$put  = (as.data.frame(rub3m) %>% mutate(put = GBSOption('p', rub, rub, 90/365, swap, 0, iv)@price))[, c('put')\n\n\n# What if we do not hedge?\n\n\n  usd_diff = lag(diff(rub3m$rub, 90*5/7), k=-90*5/7)\n  usd_roc = usd_diff /  rub3m$rub %>% na.omit\n\n\n\n\n# +--------------+\n# | Call result\n# +--------------+\n\n  usd_up = usd_diff \n  usd_up[usd_up<0,] = 0\n  \n  call_result = (usd_up - rub3m$call) / rub3m$rub\n   \n\n  # Средний прирост доллара за 90 дней:\n\n  usd_roc_df =data.frame(\n    Period = c('All', '2010 - 2013', '2014+'), \n    USD_risk = c(mean(-usd_roc, na.rm = T), \n                      mean(-usd_roc['2010/2013'], na.rm = T), \n                      mean(-usd_roc['2014/2015'], na.rm = T)) )\n  \n\n  # Средний результа по коллу за 90 дней:\n \n  call_res_df = data.frame(\n    Period = c('All', '2010 - 2013', '2014+'), \n    Call_result = c(mean(call_result, na.rm = T), \n               mean(call_result['2010/2013']), \n               mean(call_result['2014'])))\n  \n\naver_hedge_res = full_join(usd_roc_df, call_res_df, by = 'Period') %>% mutate(Hedged_risk = USD_risk + Call_result)\n\nforeach( i=2:4) %do%{\n  aver_hedge_res[, i] = paste(round(aver_hedge_res[, i]  * 100, digits = 2), '%', sep='')\n}\n\nnames(aver_hedge_res) = c('Период', 'Валютный риск', 'Результат опциона', 'Хеджированный риск')\nres_grob = tableGrob(aver_hedge_res, name='test')\n\n\nusd_down = usd_diff \nusd_down[usd_down>0, ]=0\n\nmean(-usd_diff[usd_diff<0, ]/rub3m$rub)\nmean((-usd_diff[usd_diff<0, ] - rub3m$call)/rub3m$rub, na.rm = T)\n\n # Price change to call price\nrub3m$difftocall = rub3m$diff / rub3m$call \n\nabsDiffToCall = abs(rub3m$diff) / rub3m$call\nsummary(absDiffToCall)\nautoplot(absDiffToCall)\n\nfinal_res =  merge(merge(call_result, -usd_diff/rub3m$rub), call_result-usd_diff/rub3m$rub) %>% na.omit\nnames(final_res) = c('Call_Profit', 'USD_risk', 'Hedged')\n\n\n\n\nchart1 = ggplot() +  theme_grey(base_size = 18) +\n  geom_line(\n    data=fortify(final_res[,c('Call_Profit')], melt=T), \n    aes(x=Index, y=Value, color=Series)) +\n  scale_colour_manual(\n    values = c(\"red\"), \n    name='На графике:', \n    labels=c('Результат опциона call')) +\n  theme(\n    legend.position=c(0,1), \n    legend.justification=c(0,1), \n    legend.margin = unit(0, \"cm\"),\n    legend.background = element_blank(),\n    axis.text.x = element_blank()) +  #, plot.margin=unit(c(0,0,0,0), 'cm')\n  labs(title='Хеджирование опционом call', x=NULL, y=NULL) + \n  scale_y_continuous(labels = percent) + \n  geom_segment(\n    aes(x=as.Date('2014-01-01'), y=-0.4, xend=as.Date('2014-06-01'), yend=-0.5), \n    arrow = arrow(length = unit(0.2, 'cm'), type = 'closed')) #+\n  #annotate('text', x=as.Date('2013-01-01'), y=-0.4, label='Рост доллара - риск для импортёра, \\n поэтому график инвертирован')\n\n\nchart2 = ggplot() +  theme_grey(base_size = 18) +\n  geom_area(data=fortify(final_res[,c('Hedged', 'USD_risk')], melt=T), aes(x=Index, y=Value, fill=Series)) + \n  scale_fill_manual(\n    values = c('red', 'black'),\n    name = 'Валютный риск:',\n    labels=c('Захеджированный', 'Без хеджрования')) +\n  scale_y_continuous(labels = percent,\n                     breaks=seq(-1,1,0.2)) +  \n  theme(title = element_text(size=14),\n        legend.position=c(0,0),\n        legend.justification = c(0,0),\n        legend.background = element_blank()) + \n  labs(title = 'Валютные риски импортёра' , x=NULL, y=NULL) +\n  geom_segment(    \n    aes(x=as.Date('2014-01-01'), y=-0.4, xend=as.Date('2014-06-01'), yend=-0.5), \n    arrow = arrow(length = unit(0.2, 'cm'), type = 'closed')) +\n  annotate('text', x=as.Date('2013-03-01'), y=-0.35, label='Рост доллара - риск для импортёра') +\n  geom_segment(    \n    aes(x=as.Date('2011-06-01'), y=0.3, xend=as.Date('2011-01-01'), yend=0.2), \n    arrow = arrow(length = unit(0.2, 'cm'), type = 'closed')) +\n  geom_segment(    \n    aes(x=as.Date('2012-01-01'), y=0.3, xend=as.Date('2012-01-01'), yend=0.2), \n    arrow = arrow(length = unit(0.2, 'cm'), type = 'closed')) +\n  annotate('text', x=as.Date('2011-06-01'), y=0.35, label='Импортёр выигрывает от укрепления рубля')\n\n  \ngrid.arrange(chart2, res_grob, nrow=2, heights=c(1, 0.5))\n\n\n\n\n\n",
    "created" : 1442390374642.000,
    "dirty" : false,
    "encoding" : "CP1251",
    "folds" : "",
    "hash" : "4132319908",
    "id" : "FEFFE871",
    "lastKnownWriteTime" : 1442478705,
    "path" : "~/RBackup/HedgeBacktest/callbacktest.R",
    "project_path" : "callbacktest.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_source"
}